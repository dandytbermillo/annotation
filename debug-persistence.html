<!DOCTYPE html>
<html>
<head>
    <title>Debug PostgreSQL Persistence</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #58a6ff; }
        h2 { color: #79c0ff; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .success { background: #0d2818; border-color: #2ea043; }
        .error { background: #3d1519; border-color: #f85149; }
        .info { background: #1c2128; border-color: #58a6ff; }
        .warning { background: #2d1f00; border-color: #d29922; }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2ea043; }
        pre {
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #30363d;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .section {
            background: #0d1117;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        .log {
            height: 300px;
            overflow-y: auto;
            background: #010409;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
        }
        .key { color: #79c0ff; }
        .value { color: #a5d6ff; }
        .error-text { color: #f85149; }
        .success-text { color: #2ea043; }
        .warning-text { color: #d29922; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug PostgreSQL Persistence</h1>
        
        <div class="grid">
            <div class="section">
                <h2>Environment Check</h2>
                <div id="env-status"></div>
                <button onclick="checkEnvironment()">Check Environment</button>
                <button onclick="checkPersistenceAdapter()">Check Adapter</button>
            </div>
            
            <div class="section">
                <h2>API Test</h2>
                <div id="api-status"></div>
                <button onclick="testAPI()">Test API Connection</button>
                <button onclick="testDirectSave()">Test Direct Save</button>
            </div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>Console Output</h2>
                <div class="log" id="console-log"></div>
            </div>
            
            <div class="section">
                <h2>Database Status</h2>
                <div id="db-status"></div>
                <button onclick="checkDatabase()">Check Database</button>
                <button onclick="clearLog()">Clear Log</button>
            </div>
        </div>

        <div class="section">
            <h2>Application State</h2>
            <div id="app-state"></div>
            <button onclick="injectDebugCode()">Inject Debug Code</button>
            <button onclick="checkLocalStorage()">Check Local Storage</button>
        </div>
    </div>

    <script>
        const log = (msg, type = 'info') => {
            const logDiv = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error-text' : 
                             type === 'success' ? 'success-text' : 
                             type === 'warning' ? 'warning-text' : '';
            logDiv.innerHTML += `<div>[${time}] <span class="${colorClass}">${msg}</span></div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        async function checkEnvironment() {
            log('Checking environment configuration...');
            const envDiv = document.getElementById('env-status');
            
            try {
                // Check environment variables
                const envVars = {
                    'NEXT_PUBLIC_POSTGRES_ENABLED': process.env.NEXT_PUBLIC_POSTGRES_ENABLED,
                    'Window object': typeof window !== 'undefined' ? 'Available' : 'Not available',
                    'Process.env': typeof process !== 'undefined' ? 'Available' : 'Not available'
                };

                let html = '<h3>Environment Variables:</h3><pre>';
                for (const [key, value] of Object.entries(envVars)) {
                    html += `<span class="key">${key}:</span> <span class="value">${value || 'undefined'}</span>\n`;
                }
                html += '</pre>';
                
                // Check if PostgreSQL should be enabled
                const shouldUsePostgres = process.env.NEXT_PUBLIC_POSTGRES_ENABLED === 'true';
                html += `<div class="status ${shouldUsePostgres ? 'success' : 'warning'}">
                    PostgreSQL should be: ${shouldUsePostgres ? 'ENABLED' : 'DISABLED'}
                </div>`;
                
                envDiv.innerHTML = html;
                log(`Environment check complete. PostgreSQL: ${shouldUsePostgres ? 'ENABLED' : 'DISABLED'}`, 
                    shouldUsePostgres ? 'success' : 'warning');
            } catch (error) {
                envDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
                log(`Environment check error: ${error.message}`, 'error');
            }
        }

        async function checkPersistenceAdapter() {
            log('Checking persistence adapter configuration...');
            const envDiv = document.getElementById('env-status');
            
            try {
                // Check what the platform detection would return
                const response = await fetch('http://localhost:3000/api/persistence?method=debug');
                
                if (!response.ok) {
                    // Try to get persistence preference through the app
                    const script = `
                        console.log('[DEBUG] Checking persistence configuration...');
                        if (typeof window !== 'undefined' && window.__APP_STATE__) {
                            console.log('[DEBUG] App state:', window.__APP_STATE__);
                        }
                        console.log('[DEBUG] NEXT_PUBLIC_POSTGRES_ENABLED:', process.env.NEXT_PUBLIC_POSTGRES_ENABLED);
                    `;
                    
                    envDiv.innerHTML += `
                        <div class="status info">
                            <p>To check persistence in the app, open the browser console at http://localhost:3000 and look for:</p>
                            <pre>"Using PostgreSQL via API routes" or "Using indexeddb persistence adapter"</pre>
                        </div>
                    `;
                }
                
                log('Persistence adapter check complete');
            } catch (error) {
                log(`Adapter check error: ${error.message}`, 'error');
            }
        }

        async function testAPI() {
            log('Testing PostgreSQL API connection...');
            const apiDiv = document.getElementById('api-status');
            
            try {
                const response = await fetch('http://localhost:3000/api/persistence?method=load&docName=api-test');
                const data = await response.json();
                
                if (response.ok) {
                    apiDiv.innerHTML = '<div class="status success">‚úÖ API is responding correctly</div>';
                    log('API connection successful', 'success');
                    
                    // Test write
                    const writeResponse = await fetch('http://localhost:3000/api/persistence', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            method: 'persist',
                            docName: 'debug-test-' + Date.now(),
                            update: Array.from(new TextEncoder().encode('Debug test'))
                        })
                    });
                    
                    if (writeResponse.ok) {
                        apiDiv.innerHTML += '<div class="status success">‚úÖ Write test successful</div>';
                        log('API write test successful', 'success');
                    }
                } else {
                    apiDiv.innerHTML = `<div class="status error">‚ùå API Error: ${data.error}</div>`;
                    log(`API error: ${data.error}`, 'error');
                }
            } catch (error) {
                apiDiv.innerHTML = `<div class="status error">‚ùå Connection failed: ${error.message}</div>`;
                log(`Connection error: ${error.message}`, 'error');
            }
        }

        async function testDirectSave() {
            log('Testing direct save to PostgreSQL...');
            const apiDiv = document.getElementById('api-status');
            
            try {
                const testData = {
                    method: 'persist',
                    docName: 'direct-test-' + Date.now(),
                    update: Array.from(new TextEncoder().encode(JSON.stringify({
                        test: true,
                        timestamp: new Date().toISOString(),
                        message: 'Direct save test'
                    })))
                };
                
                const response = await fetch('http://localhost:3000/api/persistence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    log(`Saved document: ${testData.docName}`, 'success');
                    
                    // Try to load it back
                    const loadResponse = await fetch(`http://localhost:3000/api/persistence?method=load&docName=${testData.docName}`);
                    const loadData = await loadResponse.json();
                    
                    if (loadData.data) {
                        const decoded = new TextDecoder().decode(new Uint8Array(loadData.data));
                        apiDiv.innerHTML += `
                            <div class="status success">
                                ‚úÖ Save and load successful!
                                <pre>${decoded}</pre>
                            </div>
                        `;
                        log('Direct save/load test passed', 'success');
                    }
                } else {
                    const error = await response.json();
                    apiDiv.innerHTML += `<div class="status error">‚ùå Save failed: ${error.error}</div>`;
                    log(`Save failed: ${error.error}`, 'error');
                }
            } catch (error) {
                log(`Direct save error: ${error.message}`, 'error');
            }
        }

        async function checkDatabase() {
            log('Checking database contents...');
            const dbDiv = document.getElementById('db-status');
            
            try {
                // Check for any documents in the database
                const patterns = ['note:', 'annotation:', 'document:', 'debug-', 'direct-', ''];
                let found = 0;
                let html = '<h3>Database Contents:</h3>';
                
                for (const pattern of patterns) {
                    const response = await fetch(`http://localhost:3000/api/persistence?method=getAllUpdates&docName=${pattern}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.updates && data.updates.length > 0) {
                            found += data.updates.length;
                            html += `<div class="status info">Pattern "${pattern || 'all'}": ${data.updates.length} updates</div>`;
                            log(`Found ${data.updates.length} updates for pattern "${pattern}"`, 'info');
                        }
                    }
                }
                
                if (found === 0) {
                    html += '<div class="status warning">‚ö†Ô∏è No documents found in PostgreSQL</div>';
                    log('No documents found in database', 'warning');
                } else {
                    html += `<div class="status success">‚úÖ Total: ${found} updates in PostgreSQL</div>`;
                    log(`Total ${found} updates found in database`, 'success');
                }
                
                dbDiv.innerHTML = html;
            } catch (error) {
                dbDiv.innerHTML = `<div class="status error">‚ùå Database check error: ${error.message}</div>`;
                log(`Database check error: ${error.message}`, 'error');
            }
        }

        function injectDebugCode() {
            log('Injecting debug code instructions...');
            const stateDiv = document.getElementById('app-state');
            
            const debugCode = `
// Paste this in the browser console at http://localhost:3000:

// Check if PostgreSQL is enabled
console.log('NEXT_PUBLIC_POSTGRES_ENABLED:', process.env.NEXT_PUBLIC_POSTGRES_ENABLED);

// Check platform detection
import { getPlatformCapabilities, getPreferredPersistence } from './lib/utils/platform-detection';
console.log('Platform capabilities:', getPlatformCapabilities());
console.log('Preferred persistence:', getPreferredPersistence());

// Check if EnhancedCollaborationProvider is using PostgreSQL
if (window.__PROVIDER__) {
    console.log('Provider persistence:', window.__PROVIDER__.persistence);
}
`;
            
            stateDiv.innerHTML = `
                <div class="status info">
                    <h3>Debug Code (paste in browser console):</h3>
                    <pre>${debugCode}</pre>
                    <p>This will help identify why PostgreSQL isn't being used.</p>
                </div>
            `;
            log('Debug code ready to copy', 'info');
        }

        function checkLocalStorage() {
            log('Checking local storage...');
            const stateDiv = document.getElementById('app-state');
            
            try {
                const keys = Object.keys(localStorage);
                let html = '<h3>Local Storage:</h3><pre>';
                
                keys.forEach(key => {
                    if (key.includes('annotation') || key.includes('yjs') || key.includes('postgres')) {
                        const value = localStorage.getItem(key);
                        html += `<span class="key">${key}:</span> <span class="value">${value?.substring(0, 50)}...</span>\n`;
                    }
                });
                
                html += '</pre>';
                
                // Check IndexedDB
                html += '<h3>IndexedDB Check:</h3>';
                if ('indexedDB' in window) {
                    indexedDB.databases().then(databases => {
                        const dbInfo = databases.map(db => `${db.name} (v${db.version})`).join(', ');
                        stateDiv.innerHTML += `<div class="status info">Databases: ${dbInfo || 'None'}</div>`;
                    });
                }
                
                stateDiv.innerHTML = html;
                log('Local storage check complete', 'success');
            } catch (error) {
                log(`Local storage error: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
            log('Log cleared');
        }

        // Auto-run checks on load
        window.onload = () => {
            log('Debug tool loaded');
            checkEnvironment();
            setTimeout(testAPI, 1000);
            setTimeout(checkDatabase, 2000);
        };
    </script>
</body>
</html>